@(js: String, nlogoCode: String)

<html>
  <head></head>
  <body>

    <label>speed<input id="speed-slider" type="range" min=0 max=8 step=.01 style="width: 400px"></input></label>
    ticks: <span id="tick-counter"></span>
    <br/>
    <input type="button" onclick="setup();" value="setup"></input>
    <input id="go-button" type="button" onclick="toggleGo();" value="go"></input>

    <div class='view-container' style="width: 600px;"></div>

    <div id='netlogo-code-wrapper' style="margin-top: 10px;">
      <input id='toggle-code-button' type="button" onclick="toggleCodeVisibility();" value="Show NetLogo Code"></input>
      <pre id='netlogo-code' style="margin: 0; visibility: hidden; border: 2px solid gray; padding: 15px;
                                    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;">
@Html(nlogoCode)
      </pre>
    </div>

    <script type="text/javascript">
      @Html(js)
    </script>

    <script type="text/javascript">

      var session     = new SessionLite(document.getElementsByClassName('view-container')[0])
      var runner      = -1;
      var tickCounter = document.getElementById('tick-counter');
      var lastUpdate  = 0;

      // If the HTML was saved in the non-default state, correct it.
      window.addEventListener('load', initPage);

      function updateTickCounter() {
        tickCounter.textContent = typeof world.ticks() === 'number' ? world.ticks() : '';
      }

      function goForever() {

        var speed      = Math.exp(document.getElementById('speed-slider').value);
        var delta      = Math.min(new Date().getTime() - lastUpdate, 30);
        var numUpdates = speed * delta / 1000 + 1;

        for (var i=0; i < numUpdates; i++) {
          GO();
        }

        updateTickCounter();
        session.update(collectUpdates());

        lastUpdate = new Date().getTime();
        runner     = setTimeout(goForever, 1000 / speed);

      }

      function setup() {
        SETUP();
        session.update(collectUpdates());
        updateTickCounter();
      }

      function stop() {
        clearTimeout(runner);
        runner = -1;
      }

      function toggleGo() {
        var goButton = document.getElementById('go-button');
        if (runner < 0) {
          goForever();
          goButton.value = "stop";
        } else {
          stop();
          goButton.value = "go";
        }
      }

      function initPage() {
        tickCounter.textContent = '0';
        document.getElementById('go-button').value = 'go'
        initCodeVisibility();
      }


      // NetLogo code visibility stuff below

      const VISIBILITY_CSS = 'visibility';
      const HIDDEN_CSS     = 'hidden';
      const SHOW_STR       = 'Show NetLogo Code'
      const HIDE_STR       = 'Hide NetLogo Code'

      var codeSpan         = document.getElementById('netlogo-code');
      var toggleCodeButton = document.getElementById('toggle-code-button');

      function initCodeVisibility() {
        codeSpan.style[VISIBILITY_CSS] = HIDDEN_CSS;
        toggleCodeButton.value         = SHOW_STR;
      }

      function toggleCodeVisibility() {

        var style     = window.getComputedStyle(codeSpan);
        var isVisible = style.getPropertyValue(VISIBILITY_CSS) !== HIDDEN_CSS;

        if (isVisible) {
          codeSpan.style[VISIBILITY_CSS] = HIDDEN_CSS;
          toggleCodeButton.value         = SHOW_STR;
        }
        else {
          codeSpan.style[VISIBILITY_CSS] = 'visible';
          toggleCodeButton.value         = HIDE_STR;
        }

      }

    </script>

  </body>
</html>
