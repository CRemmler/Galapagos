@(js: String, nlogoCode: String, info: String)

<html>
  <head>
    <script>useGoogleGraph = false</script>
    <!--
    Uncomment if you'd like to use google graphs!
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script>useGoogleGraph = true</script>
    -->
  </head>
  <body>


    <div style="display: flex; flex-direction: row; display: -webkit-box;">

      <label>speed<input id="speed-slider" type="range" min=0 max=1 step=.01 style="width: 400px"></input></label>
      ticks: <span id="tick-counter"></span>

      <div id="powered-by-wrapper" style="margin-left: 20px; margin-top: 8px;">
        <a href="http://ccl.northwestern.edu/netlogo/">
          <img style="vertical-align: middle;" alt="NetLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAANcSURBVHjarJRdaFxFFMd/M/dj7252uxubKms+bGprVyIVbNMWWqkQqtLUSpQWfSiV+oVFTcE3DeiDgvoiUSiCYLH2oVoLtQ+iaaIWWtE2FKGkkSrkq5svN+sm7ma/7p3x4W42lEbjQw8MM8yc87/nzPnNFVprbqWJXyMyXuMqx1Ni6N3ny3cX8tOHNLoBUMvESoFI2Xbs4zeO1lzREpSrMSNS1zkBDv6uo1/noz1H7mpvS4SjprAl2AZYEqzKbEowBAgBAkjPKX2599JjT7R0bj412D0JYNplPSBD1G2SmR/e6u1ikEHG2vYiGxoJmxAyIGSCI8GpCItKimtvl2JtfGujDNkX6epuAhCjNeAZxM1ocPy2Qh4toGQ5DLU+ysiuA2S3P0KgJkjAgEAlQylAA64CG/jlUk6//ng4cNWmLK0yOPNMnG99Rs9LQINVKrD+wmke7upg55PrWP3eYcwrlykpKCkoelDy/HVegQhoABNAepbACwjOt72gZkJhypX70YDWEEklue+rbnYc2MiGp1upPfYReiJJUUG58gFXu4udch1wHcjFIgy0HyIjb2yvBpT2F6t+6+f+D15lW8c9JDo7iPSdgVIRLUqL2AyHDQAOf9hfbqxvMF98eT3RuTS1avHyl+Stcphe2chP9+4k/t3RbXVl3W+Ws17FY56/w3VcbO/koS/eZLoAqrQMxADZMTYOfwpwoWjL4+bCYcgssMqGOzPD6CIkZ/3SxTJ0ayFIN6/BnBrZb2XdE1JUgkJWkfrUNRJnPyc16zsbgPyXIUJBpvc+y89nk/S8/4nek3NPGeBWMwzGvhUPnP6RubRLwfODlqqx3LSCyee2MnlwMwA2RwgO5qouVcHmksUdJweYyi8hZkrUjgT5t/ejNq0jBsSqNWsKyT9uFtxw7Bs585d3g46KOeT2bWHmtd14KyP+5mzqpsYU3OyioACMhGiqPTMocsrHId9cy9BLDzKxq8X3ctMwlV6yKSHL4fr4dd0DeQBTBUgUkvpE1kVPbqkX117ZzuSaFf4zyfz5n9A4lk0yNU7vyb7jTy1kmFGipejKvh6h9n0W995ZPTu227hqmCz33xXgFV1v9NzI96NfjndWt7XWCB/7BSICFWL+j3lAofpCtfYFb6X9MwCJZ07mUsXRGwAAAABJRU5ErkJggg=="/>
          <span style="font-size: 16px;">powered by NetLogo</span>
        </a>
      </div>

    </div>

    <div class='view-container' style="position:relative"></div>

    <div style="display: flex; flex-direction: row; display: -webkit-box;">
      <div id='netlogo-code-wrapper' style="margin-top: 20px; flex: 1 1; -webkit-box-flex: 1; width: 50%; margin-right: 10px;">
        <input id='toggle-code-button' type="button" onclick="toggleCodeVisibility();" value="Show NetLogo Code">
        <pre id='netlogo-code' style="margin: 0; display: none; border: 2px solid gray; padding: 15px;
                                      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;">
@Html(nlogoCode)
        </pre>
      </div>

      <div id='netlogo-info-wrapper' style="margin-top: 20px; flex: 1 1; -webkit-box-flex: 1; width: 50%;" >
        <input id='toggle-info-button' type="button" onclick="toggleInfoVisibility();" value="Show Model Info">
        <div id='netlogo-info' style="margin: 0; display: none; border: 2px solid gray; padding: 15px;">
          @info
        </div>
      </div>
    </div>

    <script type="text/javascript">

      @Html(js)

      <!-- If it has child nodes, it has already been parsed from Markdown. --JAB (8/28/14) -->
      <!-- Grabbing `nodeValue` allows us to basically unescape the HTML --JAB (8/28/14) -->
      var infoElem = document.getElementById('netlogo-info');
      if (!infoElem.childNodes[0].hasChildNodes())
        infoElem.innerHTML = markdown.toHTML(infoElem.childNodes[0].nodeValue.trim());

      var session     = new SessionLite(document.getElementsByClassName('view-container')[0]);
      var runner      = -1;
      var tickCounter = document.getElementById('tick-counter');
      var lastUpdate  = 0;
      var speedSlider = document.getElementById('speed-slider');

      window.addEventListener('load', initPage);
      if(useGoogleGraph) {
        session.graph = GoogleGraph;
        Grapher.graph = GoogleGraph;
      }

      Widgets.addTo(session);

      function initPage() {
        speedSlider.value = 0.5;
        tickCounter.textContent = '0';
        initCodeVisibility();
        initInfoVisibility();
      }

      // NetLogo code visibility stuff below

      const VISIBILITY_CSS = 'display';
      const HIDDEN_CSS     = 'none';
      const SHOW_STR       = 'Show ';
      const HIDE_STR       = 'Hide ';
      const CODE_LABEL     = 'NetLogo Code';
      const INFO_LABEL     = 'Model Info';

      var codeSpan         = document.getElementById('netlogo-code');
      var infoSpan         = document.getElementById('netlogo-info');
      var toggleCodeButton = document.getElementById('toggle-code-button');
      var toggleInfoButton = document.getElementById('toggle-info-button');

      function initVisibility(textElem, button, label) {
        textElem.style[VISIBILITY_CSS] = HIDDEN_CSS;
        button.value                   = SHOW_STR + label;
      }

      function toggleVisibility(span, button, label) {

        var style     = window.getComputedStyle(span);
        var isVisible = style.getPropertyValue(VISIBILITY_CSS) !== HIDDEN_CSS;

        if (isVisible) {
          span.style[VISIBILITY_CSS] = HIDDEN_CSS;
          button.value               = SHOW_STR + label;
        }
        else {
          span.style[VISIBILITY_CSS] = 'block';
          button.value               = HIDE_STR + label;
        }

      }

      var initCodeVisibility   = initVisibility.  bind(this, codeSpan, toggleCodeButton, CODE_LABEL);
      var toggleCodeVisibility = toggleVisibility.bind(this, codeSpan, toggleCodeButton, CODE_LABEL);
      var initInfoVisibility   = initVisibility.  bind(this, infoSpan, toggleInfoButton, INFO_LABEL);
      var toggleInfoVisibility = toggleVisibility.bind(this, infoSpan, toggleInfoButton, INFO_LABEL);

      session.update(Updater.collectUpdates());

      function updateTickCounter() {
        try {
          tickCounter.textContent = typeof world.ticker.tickCount() === 'number' ? world.ticker.tickCount() : '';
        } catch(err) {
        }
      }

      function goForever() {

        var speed      = Math.exp(speedSlider.value * 8);
        var delta      = Math.min(new Date().getTime() - lastUpdate, 30);
        var numUpdates = Math.floor(speed * delta / 1000 + 1);

        for (var i=0; i < numUpdates; i++) {
          Widgets.runUpdateFuncs()
        }

        updateTickCounter();
        session.update(Updater.collectUpdates());

        lastUpdate = new Date().getTime();
        runner     = setTimeout(goForever, 1000 / speed);

      }
      goForever()
    </script>
  </body>
</html>
