@(script: String => Html, style: String => Html)(implicit request: Request[_])

@route(path: String) = @{
  routes.Assets.at(path).absoluteURL
}

<html>
  <head>
    <base target="_parent" />
    @style(route("lib/codemirror/lib/codemirror.css"))
    @style(route("lib/codemirror/addon/dialog/dialog.css"))
    @style(route("stylesheets/widgets.css"))
    @style(route("stylesheets/netlogoweb.css"))
    @style(route("stylesheets/netlogo-syntax.css"))
    @style(route("stylesheets/spinner.css"))
    @style(route("stylesheets/alert.css"))
  </head>
  <body style="margin: 0px;">
    @views.html.spinner()
    @views.html.errorAlert()
    <div id="netlogo-model-container" style="display: inline-block;"></div>
    @script(route("lib/jquery/jquery.js"))
    @script(route("lib/filesaver.js/FileSaver.js"))
    @script(route("lib/google-caja/html-sanitizer-minified.js"))
    @script(route("lib/markdown-js/markdown.js"))
    @script(route("lib/highcharts/adapters/standalone-framework.js"))
    @script(route("lib/highcharts/highcharts.js"))
    @script(route("lib/highcharts/modules/exporting.js"))
    @script(route("lib/ractive/ractive.js"))
    @script(route("lib/codemirror/lib/codemirror.js"))
    @script(route("lib/codemirror/addon/dialog/dialog.js"))
    @script(route("lib/codemirror/addon/mode/simple.js"))
    @script(route("lib/codemirror/addon/search/searchcursor.js"))
    @script(route("lib/codemirror/addon/search/search.js"))

    @script(routes.CompilerService.tortoiseCompilerJs.absoluteURL)
    @script(routes.Local.engine.absoluteURL)

    @script(route("javascripts/TortoiseJS/agent/colors.js"))
    @script(route("javascripts/TortoiseJS/agent/drawshape.js"))
    @script(route("javascripts/TortoiseJS/agent/defaultshapes.js"))
    @script(route("javascripts/TortoiseJS/agent/linkdrawer.js"))
    @script(route("javascripts/TortoiseJS/agent/view.js"))
    @script(route("javascripts/TortoiseJS/agent/editor.js"))
    @script(route("javascripts/TortoiseJS/agent/info.js"))
    @script(route("javascripts/TortoiseJS/agent/output.js"))
    @script(route("javascripts/TortoiseJS/agent/console.js"))
    @script(route("javascripts/TortoiseJS/agent/title.js"))
    @script(route("javascripts/TortoiseJS/agent/widgets.js"))
    @script(route("javascripts/TortoiseJS/control/tortoise.js"))
    @script(route("javascripts/TortoiseJS/control/session-lite.js"))
    @script(route("javascripts/plot/highchartsops.js"))
    @script(route("javascripts/alert.js"))

    @helper.javascriptRouter("jsRoutes")(
      routes.javascript.Local.standalone
    )

    <!-- This can be used to insert nlogo code into this page -->
    <script type="text/nlogo" id="nlogo-code" data-filename="model.nlogo"></script>

    <script>
      var loadingOverlay  = $("#loading-overlay").get(0);
      var activeContainer = loadingOverlay;
      var modelContainer  = document.querySelector("#netlogo-model-container");
      var nlogoScript     = document.querySelector("#nlogo-code");
      var standaloneURL   = "@routes.Local.standalone.absoluteURL";
      var pageTitle       = function(modelTitle) {
        if (modelTitle != null && modelTitle != "") {
          return "NetLogo Web: " + modelTitle;
        } else {
          return "NetLogo Web";
        }
      };
      var session;
      var openSession = function(s) {
        session = s;
        document.title = pageTitle(session.modelTitle());
        activeContainer = modelContainer;
        session.startLoop();
      };

      var isStandaloneHTML = false;

      if (nlogoScript.textContent.length > 0) {
        isStandaloneHTML = true;
      }

      var nlwAlerter = new NLWAlerter($("#alert-overlay"), isStandaloneHTML);

      var displayError = function(error) {
        // in the case where we're still loading the model, we have to
        // post an error that cannot be dismissed, as well as ensuring that
        // the frame we're in matches the size of the error on display.
        if (activeContainer === loadingOverlay) {
          nlwAlerter.displayError(error, false);
          activeContainer = nlwAlerter.alertContainer;
        } else {
          nlwAlerter.displayError(error);
        }
      };

      if (nlogoScript.textContent.length > 0) {
        Tortoise.fromNlogo(nlogoScript.textContent,
                           modelContainer,
                           nlogoScript.dataset.filename,
                           openSession,
                           displayError);
      } else if (window.location.search.length > 0) {
        var url = window.location.search.slice(1);
        console.log(url);
        Tortoise.fromURL(url, modelContainer, openSession, displayError);
      }

      window.addEventListener("message", function (e) {
        if (session) {
          session.teardown();
        }
        nlwAlerter.hide();
        activeContainer = loadingOverlay;
        Tortoise.fromNlogo(e.data.nlogo, modelContainer, e.data.path, openSession, displayError);
      });

      if (parent !== window) {
        var width = "", height = "";
        window.setInterval(function() {
          if (activeContainer.offsetWidth  !== width ||
              activeContainer.offsetHeight !== height ||
              (session !== undefined && document.title != pageTitle(session.modelTitle()))) {
            if (session !== undefined) {
              document.title = pageTitle(session.modelTitle());
            }
            width = activeContainer.offsetWidth;
            height = activeContainer.offsetHeight;
            parent.postMessage({
              width:  activeContainer.offsetWidth,
              height: activeContainer.offsetHeight,
              title:  document.title
            }, "*");
          }
        }, 200);
      }
    </script>
  </body>
</html>
